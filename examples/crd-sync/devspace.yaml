version: v1beta11
vars:
  - name: PLUGIN_IMAGE
    value: loftsh/vcluster-car-plugin
  - name: K3S_IMAGE
    value: rancher/k3s:v1.23.1-k3s1
  # Replace this with your clusters service CIDR, you can find it out via
  # kubectl apply -f hack/wrong-cluster-ip-service.yaml
  - name: SERVICE_CIDR
    value: 10.96.0.0/12
images:
  vcluster:
    image: ${PLUGIN_IMAGE}
    dockerfile: ./Dockerfile.dev
    rebuildStrategy: ignoreContextChanges
hooks:
  - name: Apply Car Manifests
    events: ["after:deploy"]
    command: kubectl apply -f manifests/crds.yaml
deployments:
  - name: vcluster
    helm:
      chart:
        name: vcluster
        repo: https://charts.loft.sh
        version: 0.6.0-alpha.5
      values:
        plugin:
          car:
            image: ${PLUGIN_IMAGE}
            rbac:
              role:
                extraRules:
                  - apiGroups: ["example.loft.sh"]
                    resources: ["cars"]
                    verbs: ["create", "delete", "patch", "update", "get", "list", "watch"]
              clusterRole:
                extraRules:
                  - apiGroups: ["apiextensions.k8s.io"]
                    resources: ["customresourcedefinitions"]
                    verbs: ["get", "list", "watch"]
        serviceCIDR: ${SERVICE_CIDR}
        serviceAccount:
          create: false
          name: default
        vcluster:
          image: ${K3S_IMAGE}
        rbac:
          clusterRole:
            create: true
          role:
            extended: true
        syncer:
          readinessProbe:
            enabled: false
          livenessProbe:
            enabled: false
dev:
  terminal:
    imageSelector: ${PLUGIN_IMAGE}
    command: ["./devspace_start.sh"]
  ports:
    - imageSelector: ${PLUGIN_IMAGE}
      forward:
        - port: 2346
          remotePort: 2345
  sync:
    - imageSelector: ${PLUGIN_IMAGE}